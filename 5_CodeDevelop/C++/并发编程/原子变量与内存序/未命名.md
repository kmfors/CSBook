原子性指的是一段指令即使映射到底层，在其他核心看来，要么全部没有开始，要么全部结束了，不会让其他的核心看到执行的一个中间状态。

单核处理器实现原子性

## 单核处理器实现原子性

一个 CPU 就是一个处理器，一个处理器可能对应多核，一核可以执行一线程。

单核处理器如何实现原子性？只要保证操作指令不被中断即可。这其中涉及到两个关键：

- 1、使用底层自旋锁锁住操作（底层也没有其他锁）。
- 2、屏蔽中断。用于保障其他设备不会抢夺 cpu，以及避免加锁失败。

这些都是由操作系统完成的，基本不需要用户专门操作。

## 多核处理器实现原子性

现代的计算机基本都是多核的。在单核处理器实现原子性的基础上，还需要：其他避免其他核心操作相关的内存空间。

曾经是通过“锁总线”的操作实现的，当一个核心使用内存的时候，锁住其他核心也禁止访问内存。这种方法的弊端是其他核心连同非相关的内存空间也无法使用。现在是用 lock 操作指令只阻止其他核心访问相关的内存区域。

## 存储体系介绍

![[20240914164147.png]]


可以看出 L1 和 L2 是每个核心都会有的。L3 是一个处理器下的核心共有的。

主存（常规语境下所指的内存）是所有核心共有的。

越往下容量越大，同时读取速度越慢。

Cpu 访问缓存的时候会有一个最小的读取单位，叫做 cache line，一般是 64 个字节。

![[20240914164242.png]]

Flag 标识的是当前的缓存是否可用。

Tag 标识的是当前的缓存是否命中。

Data 是缓存数据。

**为什么要有 cache line？** 为了解决 cpu 运算速度与内存访问速度不匹配的问题。

# 参考资料

- [C++11 及上的原子操作底层原理与锁实现](https://zhuanlan.zhihu.com/p/704504454)
- 
- 

